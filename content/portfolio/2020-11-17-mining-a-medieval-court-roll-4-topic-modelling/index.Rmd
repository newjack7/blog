---
title: 'Mining a Medieval court roll 4: Topic Modelling'
author: 'Jack Newman'
date: '2020-11-17'
slug: Text Mining
categories: Text Mining
tags:
- Medieval History
- Text Mining
- Local History
image: ''
showonlyimage: no
editor_options: 
  markdown: 
    wrap: sentence
---

```{r message=FALSE, warning=FALSE, include=FALSE, messages=FALSE, warnings=FALSE}
library(tidyverse)
library(tidytext)
library(broom)
library(reshape2)
library(topicmodels)
source("C:/Users/Jack/Documents/GitHub/blog/Data processing.R", echo = FALSE)
```

**This post is a work in progress and looks at topic modelling in R. This is a statistical process that seeks to categorise text.**

This code firstly takes the columns `word` and `UUID` from the data frame `lincsTotalTidy` and creates a new data frame called `lincsDTM`.
These are columns which contain the text from the Lincoln Records Society volume (`word`) and the original reference provided by McLane (`lincsID`).
This data has been prepared in a script elsewhere and in accordance with tidy data principles it contains one word per row from the text of the Lincoln Record Society volume.
It also means that I can cast the data frame into a Document Term Matrix (DTM).
This is the format which the data must be in for topic modelling.
The final two sections cast it into a DTM and then create the topic model for six topics.

```{r Last minute tidying}
months <- c("january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december", "jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec", "sept","john", "robert", "william", "thomas", "de", "edward", "richard", "â", "atte", "alan", "kingâ")

#lincsNames <- c("john", "robert", "william", "thomas", "de", )
  
lincsDTM <- filter(lincsOCR, TYPE == 'EVENT')
lincsDTM <- lincsDTM %>%  select(QUOTE_TRANSCRIPTION, UUID)
lincsDTM <- lincsDTM %>% rename(word = QUOTE_TRANSCRIPTION)
lincsDTM <- lincsDTM %>% unnest_tokens(word, word)

lincsDTM <- lincsDTM %>% anti_join(stop_words)
lincsDTM <- lincsDTM %>% filter(!word %in% months)
lincsDTM <- lincsDTM %>% filter(grepl('^\\D', word))
lincsDTM <- lincsDTM %>% anti_join(lincsPeople, by = 'word')
lincsDTM <- lincsDTM %>% anti_join(lincsPlaces, by = 'word')
                                   
#Cast into DTM and run the topic model
lincsDTM <- lincsDTM %>% 
  select(word, UUID) %>% 
  count(word, UUID) %>% 
  cast_dtm(UUID, word, n)

lincsLDA <- LDA(lincsDTM, k = 12, control = list(seed = 1234))
```

```{r create and view the topic models}
lincsTopics <- tidy(lincsLDA, matrix = "beta")
lincsTopics
```

```{r visualise the topics}

#Creates List of top terms that belong to each topic

lincsTopTerms <- lincsTopics %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)

#Visualises the top terms
lincsTopTerms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()

#write.csv(lincsTopTerms, "C:\\Users\\Jack\\Documents\\GitHub\\blog\\Lincolnshire csv Data\\topicModeltop20.csv")

```

I need to test these terms to see if I agree with the topics and if I need to adjust the number of topics up or down from six.
So first I will create a new table which contains the topics, the ID from McLane, and the text of the allegations.
That way I can determine if they belong together.

```{r create variables}
lincsTopTerms <- lincsTopTerms %>% rename(lincsID = term)

#Create Dataframes for each topic
topicOne <- lincsTopTerms %>% filter(topic == 1)
topicTwo <- lincsTopTerms %>% filter(topic == 2)
topicThree <- lincsTopTerms %>% filter(topic == 3)
topicFour <- lincsTopTerms %>% filter(topic == 4)
topicFive <- lincsTopTerms %>% filter(topic == 5)
topicSix <- lincsTopTerms %>% filter(topic == 6)
topicSeven <- lincsTopTerms %>% filter(topic == 7)
topicEight <- lincsTopTerms %>% filter(topic == 8)
topicNine <- lincsTopTerms %>% filter(topic == 9)
topicTen <- lincsTopTerms %>% filter(topic == 10)

#Now I want to join all of these to the allegations so I can read them easily in one place
topicOne <- topicOne %>% inner_join(lincsEvents)
#Remove the Duplicates
topicOne <-  topicOne[!duplicated(topicOne$lincsID), ]

#Repeat for each topic
topicTwo <- topicTwo %>% inner_join(lincsEvents)
topicTwo <-  topicTwo[!duplicated(topicTwo$lincsID), ]

topicThree <- topicThree %>% inner_join(lincsEvents)
topicThree <-  topicThree[!duplicated(topicThree$lincsID), ]

topicFour <- topicFour %>% inner_join(lincsEvents)
topicFour <-  topicFour[!duplicated(topicFour$lincsID), ]

topicFive <- topicFive %>% inner_join(lincsEvents)
topicFive <-  topicFive[!duplicated(topicFive$lincsID), ]

topicSix <- topicSix %>% inner_join(lincsEvents)
topicSix <-  topicSix[!duplicated(topicSix$lincsID), ]

topicSeven <- topicSeven %>% inner_join(lincsEvents)
topicSeven <-  topicSeven[!duplicated(topicSeven$lincsID), ]


topicEight <- topicEight %>% inner_join(lincsEvents)
topicEight <-  topicEight[!duplicated(topicEight$lincsID), ]

topicNine <- topicNine %>% inner_join(lincsEvents)
topicNine <-  topicNine[!duplicated(topicNine$lincsID), ]

topicTen <- topicTen %>% inner_join(lincsEvents)
topicTen <-  topicTen[!duplicated(topicTen$lincsID), ]


#Join all the dataframes together
topics <- do.call("rbind", list(topicOne, topicTwo, topicThree, topicFour, topicFive, topicSix, topicSeven, topicEight, topicNine, topicTen))
  
  
#I write the result to CSV so I can read it more easily
write.csv(topics, "C:\\Users\\Jack\\Documents\\GitHub\\blog\\Lincolnshire csv Data\\topics.csv")

```

**Topic one**

The first topic is entirely related to the theft of foodstuff and one allegation of forestalling.
A practice common today and known in North America as scalping for some reason.

**Topic two**

The ten most common allegations in topic two relate to the extortion by royal officials.
Primarily tax collectors there is also one charge against a sequestrator of the bishop of Lincoln and one against the keepers of the king's horses.

**Topic three**

Topic three is particularly morbid and is taken up with assaults, murders, and three charges that coroners failed to do their duty concerning the viewing or burial of bodies.

**Topic four**

The fourth topic is associated with large scale, usually public, violence.
The first eight charges all relate to allegations of violence against large groups of individuals within Lincoln.
This is connected with a seeming feud between the town officials and Thomas Carlton an under-sheriff and former clerk of the town who at one point stole the town seal, ejected the mayor, issued his own members for parliament, rescued a friend from captivity by the king, and finally attacked the bailiffs of this same court and stole the list of fines.
It is satisfying that these crimes were grouped together even though the names, dates, and locations were removed from the analysis.

**Topic five**

This contains four written bills of complaint.
These were fairly unusual as most complaints made to the court were oral.
The rest related to crimes of conspiracy or others connected with legal or administrative offences.

**Topic six**

Entirely connected to the crimes of wool collectors.

**Topic seven**

Escheators, archdeacons, vicars, and commissaries are grouped together in topic seven.
Most of the crimes relate to seizure or theft of items or withholding of services.
They may have been grouped as the charges tend to be longer and more formulaic.
The model placed them with the commission which is essentially a long list of officials.
It may be worthwhile running the model with this charge excluded.

**Topic eight**

Again relates entirely to the crimes of wool collectors.
Particularly those which state the wool was kept for personal use and did not go to the king or was not paid for.
The distinction between topic six and topic eight appears to reflect a distinction in scribal practice as many of the charges are consecutive.

**Topic nine**

This selected gaol delivery hearings - essentially the sessions in which the justices decided guilt or innocence and passed sentence.
It also contains allegations against bailiffs and sheriffs.
These were likely grouped as the sheriff was responsible for bringing and removing the prisoners during the gaol delivery hearings.
It seems to be capturing the legal process and complaints about the legal process.

**Topic ten**

These relate entirely to jury decisions.

```{r}
#Remove digits from the topic term list
#lincsTopicDigitFree <- lincsTopics
#lincsTopicDigitFree <- lincsTopics[-grep('^\\d+$', lincsTopics$term),]
#Creates List of top terms that belong to each topic

#lincsTopDigitFree <- lincsTopicDigitFree %>%
#  group_by(topic) %>%
#  top_n(10, beta) %>%
#  ungroup() %>%
#  arrange(topic, -beta)

#Visualises the top terms
#lincsTopDigitFree %>%
 # mutate(term = reorder_within(term, beta, topic)) %>%
  #ggplot(aes(beta, term, fill = factor(topic))) +
  #geom_col(show.legend = FALSE) +
  #facet_wrap(~ topic, scales = "free") +
  #scale_y_reordered()

```
